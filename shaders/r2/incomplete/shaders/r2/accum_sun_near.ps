#include "common.h"
#include "lmodel.h"
#include "shadow.h"

/*
half 	shadow_sun	(float4 tc)		{
	float 	scale	= 1.25f/float(SMAP_size);
	half3	total;
	half3 	line;
		line.x 	= tex2Dproj	(s_smap,tc + tc.w*float4(-1,-1,0,0)*scale).x;
		line.y 	= tex2Dproj	(s_smap,tc + tc.w*float4( 0,-1,0,0)*scale).y;
		line.z 	= tex2Dproj	(s_smap,tc + tc.w*float4(+1,-1,0,0)*scale).z;
		total.x	= dot	(line,1.h/3.h);
		line.x 	= tex2Dproj	(s_smap,tc + tc.w*float4(-1, 0,0,0)*scale).x;
		line.y 	= tex2Dproj	(s_smap,tc + tc.w*float4( 0, 0,0,0)*scale).y;
		line.z 	= tex2Dproj	(s_smap,tc + tc.w*float4(+1, 0,0,0)*scale).z;
		total.y	= dot	(line,1.h/3.h);
		line.x 	= tex2Dproj	(s_smap,tc + tc.w*float4(-1,+1,0,0)*scale).x;
		line.y 	= tex2Dproj	(s_smap,tc + tc.w*float4( 0,+1,0,0)*scale).y;
		line.z 	= tex2Dproj	(s_smap,tc + tc.w*float4(+1,+1,0,0)*scale).z;
		total.z	= dot	(line,1.h/3.h);
	return	dot(total,1.h/3.h);
	// return 	tex2Dproj (s_smap,tc).x;
}
*/
uniform float4x4	m_shadow;

#ifdef USE_SUNFILTER
float4 	main		( float2 tc : TEXCOORD0, float4 tcJ : TEXCOORD1 ) : COLOR
{
  float4 	_P	= tex2D 	(s_position, 	tc); 
		_P.w 	= 1.f		;
	float4 	PS	= mul		(m_shadow, 	_P);
	half 	s 	= shadowtest_sun(PS,tcJ);
	return 	s	;
}
#else
float4 	main		( float2 tc : TEXCOORD0, float4 tcJ : TEXCOORD1 ) : COLOR
{
  float4 _P		= tex2D 	(s_position, 	tc); 
  half4  _N		= tex2D 	(s_normal,   	tc); 

	// ----- light-model
	half4	light 	= plight_infinity (_P.w,_P,_N,Ldynamic_dir);

	// ----- shadow
  	float4 	P4 	= float4	(_P.x,_P.y,_P.z,1.f);
	float4 	PS	= mul		(m_shadow, 	P4);
	half 	s 	= 1.h;
	#ifdef 	USE_SJITTER
	  s 	= shadowtest_sun 	(PS,tcJ);
	#else
	  s 	= shadow		(PS);
	#endif

	return 		blend		(Ldynamic_color * light * s,tc);
}
#endif